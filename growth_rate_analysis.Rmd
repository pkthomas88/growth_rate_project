---
title: "Growth rate analysis"
author: "Patrick Thomas"
date: "Nov 7 2021"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float:
      collapsed: true
---


# Setup, data import and checking

> load packages and set theme

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(psych)
library(growthrates)
library(knitr)
library(growthrates)
library(googledrive)

theme_set(theme_bw()+
            theme(axis.text=element_text(size=16),
  axis.title.x = element_text(size = 16),
  axis.title.y = element_text(size = 16),
  strip.text = element_text(size=16)))

```

> run the following to install growthTools and its required packages, if necessary

```{r}
# install.packages("remotes")
# remotes::install_github("ctkremer/mleTools")
# remotes::install_github("ctkremer/growthTools")
library(growthTools)

```

> create list of files to combine

```{r}

#create list of growth data files
growth_files <- list.files("C:/Users/pktho/OneDrive/Growth rates paper/growth_rate_project", # change this based on location of files
                        pattern = "growthdata.csv",  # Limit to just files ending in growthdata.csv
                        recursive = TRUE,  # Search within subfolders
                        full.names = TRUE) # Return full paths

growth_files

# create list of metadata files
metadata_files <- list.files("C:/Users/pktho/OneDrive/Growth rates paper/growth_rate_project", # change this based on location of files
                        pattern = "metadata.csv",  # Limit to just files ending in growthdata.csv
                        recursive = TRUE,  # Search within subfolders
                        full.names = TRUE) # Return full paths

metadata_files

```


> combine data files based on above list

```{r}
df <- lapply(growth_files, function(i){
  x=read_csv(i, na = "NA", col_types = cols(colonial = col_character(),
                                            time_acclimation = col_character(),
                                            RFU_excitation_emission = col_character()))
  x$filename = i
  x
})

#df[[1]] # to look at a certain data file for example

df=do.call("bind_rows", df) # binds all data frames read in above, but requires same column names or it will create duplicat columns!

#combine researcher ID with unique ID to make sure it's unique across all datasets
df <- df %>% mutate(unique_ID = paste(researcher_ID, unique_ID, sep = '_'))

```

> combine metadata files based on above metadata file list

```{r}

metadata <- lapply(metadata_files, function(i){
  x=read_csv(i, na = "NA", col_types = cols(colonial = col_character(),
                                            time_acclimation = col_character(),
                                            RFU_excitation_emission = col_character()))
  x$filename = i
  x
})

metadata=do.call("bind_rows", metadata)
metadata <- metadata %>% mutate(unique_ID = paste(researcher_ID, unique_ID, sep = '_'))

```


> stuff I have to do for now since metadata is in different places for different people

```{r}

df <- df %>% select(researcher_ID:cell_density)
df_Vanessa <- df %>% filter(researcher_ID=="Vanessa")
df_Vanessa <- left_join(df_Vanessa, metadata)
df <- df %>% filter(researcher_ID!="Vanessa")
df <- bind_rows(df, df_Vanessa)

```

> calculate sampling intervals, total number samples [probably add more things here later e.g., hour to day conversions, other stuff like that if necessary]

```{r}

df <- df %>% 
  #calculate number of observations and time between all observations
  group_by(unique_ID) %>% 
  mutate(time_points = length(time_days),
            interval = time_days - dplyr::lag(time_days, n =1)) 

df <- left_join(df, metadata)

```


>check out the combined data in several ways to make sure it all makes sense and was imported correctly

```{r}

dim(df)
names(df)
str(df)
summary(df)
summary_data <- describe(df)
kable(summary_data)
length(unique(df$unique_ID)) #how many total growth rate estimates will we have?
df %>% group_by(researcher_ID) %>% 
  summarize(count = length(unique(unique_ID)))#look at how many growth rates we'll have per person

```


> some plots for fun and to look at outliers and the spread of the data

```{r}

df %>%
  ggplot(aes(time_days, RFU_platereader, color = researcher_ID))+
  geom_point(alpha=.2)

df %>%
  ggplot(aes(OD, RFU_platereader, color = researcher_ID))+
  geom_point(alpha=.2)

df %>% filter(OD<1.5) %>% 
  ggplot(aes(OD, RFU_platereader, color = researcher_ID))+
  geom_point(alpha=.2)

df %>% filter(time_days <0.05) %>% 
  ggplot(aes(RFU_platereader))+
  geom_histogram()+
  facet_wrap(~researcher_ID, scales = 'free')+
  ggtitle("a look at initial densities in RFU for y0 info: \na bit of a big range now so maybe can't use the same parameters for all..?")


df %>% 
  ggplot(aes(time_points))+
  geom_histogram()

df %>% 
  ggplot(aes(interval))+
  geom_histogram()

```


# Test runs with reduced datasets

> making a small test dataset for trying different approaches, taking the first 20 experimental units where growth rate was measured [here I was too tired/stupid to figure out how to loop it by person, hence the copy/pasted code :/]

```{r}

A <- df %>% filter(researcher_ID=="AH")
IDs <- unique(A$unique_ID)
A_test <- A %>% filter(unique_ID %in% IDs[1:20])
unique(A_test$unique_ID)

B <- df %>% filter(researcher_ID=="IG")
IDs <- unique(B$unique_ID)
B_test <- B %>% filter(unique_ID %in% IDs[1:20])
unique(B_test$unique_ID)

# C <- df %>% filter(researcher_ID=="MG")
# IDs <- unique(C$unique_ID)
# C_test <- C %>% filter(unique_ID %in% IDs[1:20])
# unique(C_test$unique_ID)

D <- df %>% filter(researcher_ID=="Patrick")
IDs <- unique(D$unique_ID)
D_test <- D %>% filter(unique_ID %in% IDs[1:20])
unique(D_test$unique_ID)

E <- df %>% filter(researcher_ID=="Vanessa")
IDs <- unique(E$unique_ID)
E_test <- E %>% filter(unique_ID %in% IDs[1:20])
unique(E_test$unique_ID)

test <- bind_rows(A_test, B_test, D_test, E_test)
unique(test$unique_ID)

```


> we can have this as a supplementary figure about the computing power needed for fitting many growth rates...

![](R_session_fail.png)


## logistic

```{r}
summary(test$RFU_platereader)
summary(test)

p     <- c(y0 = 5, mumax = 0.5, K = 50)
lower <- c(y0 = 0, mumax = -5,   K = 0)
upper <- c(y0 = 30, mumax = 2,   K = 800)

start_time <- Sys.time()
test_logistic_fits <- all_growthmodels(
                   RFU_platereader ~ grow_logistic(time_days, parms) | unique_ID,
                   data = test,
                   p = p, lower = lower, upper = upper,
                   log = "y", ncores=2)
end_time <- Sys.time()
logistic_test_time <- end_time - start_time
logistic_test_time

test_logistic_results <- results(test_logistic_fits) %>% 
  mutate(model = "growthrates::logistic")%>% 
  select(unique_ID, mumax, model, r2)

```

> that approach took `r round(as.numeric(logistic_test_time), 2)` seconds to calculate `r length(unique(test$unique_ID))` growth rates

> plotting above curves

```{r}
par(mfrow = c(4, 6))
par(mar=c(1,2,1,1))
plot(test_logistic_fits, log = "y")

```

## spline

```{r}

test_spline_fits <- all_splines(RFU_platereader ~ time_days | unique_ID,
                   data = test, spar=0.5)

par(mfrow = c(4, 6))
par(mar=c(1,2,1,1))
plot(test_spline_fits, log = "y")

test_spline_results <- results(test_spline_fits) %>% 
  mutate(model = "spline") %>% 
  select(well, mumax, model, r2)

# test_logistic_results <- results(test_logistic_fits) %>% 
#   mutate(model = "growthrates::logistic")%>% 
#   select(unique_ID, mumax, model, r2)

```


## exponential

```{r}

p     <- c(y0 = 5, mumax = 0.5)
lower <- c(y0 = 0, mumax = -5)
upper <- c(y0 = 20, mumax = 5)

test_exp_fits <- all_growthmodels(
                   RFU_platereader ~ grow_exponential(time_days, parms) | unique_ID,
                   data = test,
                   p = p, lower = lower, upper = upper,
                   log = "y", ncores=2)


par(mfrow = c(4, 6))
par(mar=c(1,2,1,1))
plot(test_exp_fits, log = "y")


test_exp_results <- results(test_exp_fits) %>% 
  mutate(model = "exp")%>% 
  select(well, mumax, model, r2)

#AIC(test_exp_fits)    <- doesn't work

test_exp_fits <- results(test_exp_fits) %>% 
  mutate(model = "growthrates::exp")%>% 
  select(unique_ID, mumax, model, r2)

```


```{r}

start_time <- Sys.time()

max_diffs <- test %>% 
  mutate(logRFU = log(RFU_platereader)) %>% 
  group_by(unique_ID, researcher_ID, system) %>% 
  mutate(deltalogRFU = logRFU - dplyr::lag(logRFU, n=2)) %>% 
  mutate(deltatime = time_days - dplyr::lag(time_days, n=2)) %>% 
  mutate(mu = deltalogRFU/deltatime)

max_rates <- max_diffs %>% 
  group_by(unique_ID, researcher_ID, system) %>% 
  summarize(mumax = max(mu, na.rm = TRUE)) %>% 
  mutate(model="max_diff_2days") %>% 
  mutate(r2 = "NA") %>%
  mutate(r2=as.numeric(r2))

end_time <- Sys.time()
maxdiff_time <- end_time - start_time

```

# Growth rate calculations for full dataset

> quickly trying the 2-point growth rate approach by taking the max increase over between two adjacent time points (i.e., either 1, 2, or 4 days depending on the sampling interval)

```{r}
start_time <- Sys.time()

max_diffs <- df %>% 
  mutate(logRFU = log(RFU_platereader)) %>% 
  group_by(unique_ID, researcher_ID, system) %>% 
  mutate(deltalogRFU = logRFU - dplyr::lag(logRFU, n=1)) %>% 
  mutate(deltatime = time_days - dplyr::lag(time_days, n=1)) %>% 
  mutate(mu = deltalogRFU/deltatime)

max_rates <- max_diffs %>% 
  group_by(unique_ID, researcher_ID, system) %>% 
  summarize(mumax = max(mu, na.rm = TRUE)) %>% 
  mutate(model="max_diff_2days") %>% 
  mutate(r2 = "NA") %>%
  mutate(r2=as.numeric(r2))

end_time <- Sys.time()
maxdiff_time <- end_time - start_time

```

> that approach took `r round(as.numeric(maxdiff_time), 2)` seconds to calculate `r length(max_rates$mumax)` growth rates

>also there are a lot of NA and Inf values so need to check why that is....

```{r}
max_rates %>% ggplot(aes(mumax, fill = system))+
  geom_density(alpha = 0.7)

max_rates %>% ggplot(aes(mumax, fill = researcher_ID))+
  geom_density(alpha = 0.7)

```

> notes so far:

- combining data works pretty well overall!
- differences in formatting stuff like commas vs periods and different column names are minor problems but can be fixed
- running the full dataset in the `growthrates` package might kill my computer

```{r}

knitr::knit_exit()


```

> one way to measure time taken for e.g. growth rate calculations

```{r}
sleep_for_a_minute <- function() { Sys.sleep(5) }
start_time <- Sys.time()
sleep_for_a_minute()
end_time <- Sys.time()
end_time - start_time

```


> test with growthTools

```{r}

get.gr.lagsat(test$time_days, test$RFU_platereader)

```



